<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edge Quest</title>
    <link rel="stylesheet" href="style.css">
    <style>
        #grid {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        .row {
            display: flex;
        }
        .cell {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            margin: 2px;
        }
        #popup {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #popup-content {
            background: #fff;
            padding: 30px 40px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.5em;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
        }
        #current-direction {
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        #controls {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        #hint-btn {
            margin-left: 10px;
            background: #ff9800;
        }
        #hint-btn:hover {
            background: #e68900;
        }
        #start-btn {
            font-size: 1.2em;
            padding: 10px 30px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <h1>Edge Quest</h1>
        <div id="instructions-container">
            <pre id="instructions"></pre>
            <button id="start-btn">Start Game</button>
        </div>
        <div id="game-ui" style="display:none;">
            <div id="current-direction"></div>
            <div id="grid"></div>
            <div id="controls">
                <button onclick="move('U')">‚¨ÜÔ∏è</button>
                <button onclick="move('L')">‚¨ÖÔ∏è</button>
                <button onclick="move('D')">‚¨áÔ∏è</button>
                <button onclick="move('R')">‚û°Ô∏è</button>
                <button id="hint-btn" type="button" onclick="useHint()">üí° Hint</button>
            </div>
        </div>
    </div>

    <div id="popup">
        <div id="popup-content">
            <span id="popup-message"></span><br>
            <button onclick="closePopup()">OK</button>
        </div>
    </div>

    <script>
        var Module = {
            onRuntimeInitialized: function() {
                showInstructions();
                document.getElementById('start-btn').onclick = startGame;
            }
        };

        const emojiMap = {
            '#': 'üå≥',
            'U': '‚¨ÜÔ∏è',
            'D': '‚¨áÔ∏è',
            'L': '‚¨ÖÔ∏è',
            'R': '‚û°Ô∏è',
            'P': 'üßë‚Äçü¶±'
        };

        let lastDirection = '';
        let gameRunning = false;

        function showInstructions() {
            gameRunning = false;
            document.getElementById('instructions-container').style.display = '';
            document.getElementById('game-ui').style.display = 'none';
            document.getElementById('instructions').textContent = Module.ccall('getInstructions', 'string');
        }

        function startGame() {
            gameRunning = true;
            document.getElementById('instructions-container').style.display = 'none';
            document.getElementById('game-ui').style.display = '';
            document.getElementById('popup').style.display = 'none';
            Module.ccall('startGame', null, ['number'], [5]);
            updateGrid();
            updateCurrentDirection();
        }

        function updateGrid() {
            const gridStr = Module.ccall('getGrid', 'string');
            const lines = gridStr.trim().split('\n');
            const gridDiv = document.getElementById('grid');
            gridDiv.innerHTML = '';

            let n = lines.findIndex(line => line.indexOf('Your cell direction:') === 0);
            if (n === -1) n = lines.length;
            const gridRows = lines.slice(0, n);

            gridRows.forEach(rowStr => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'row';
                rowStr.trim().split(/\s+/).forEach(cell => {
                    const cellDiv = document.createElement('div');
                    cellDiv.className = 'cell';
                    cellDiv.textContent = emojiMap[cell] || emojiMap['#'];
                    rowDiv.appendChild(cellDiv);
                });
                gridDiv.appendChild(rowDiv);
            });

            const statusLines = lines.slice(n);
            let statusHtml = '';
            statusLines.forEach(line => {
                statusHtml += `<div>${line}</div>`;
            });
            document.getElementById('current-direction').innerHTML = statusHtml;
        }

        function updateCurrentDirection() {
            let dir = '';
            if (Module._getCurrentDirection) {
                dir = Module.ccall('getCurrentDirection', 'string');
            } else {
                const gridStr = Module.ccall('getGrid', 'string');
                const rows = gridStr.trim().split('\n');
                for (let i = 0; i < rows.length; ++i) {
                    const cells = rows[i].trim().split(/\s+/);
                    for (let j = 0; j < cells.length; ++j) {
                        if (cells[j] === 'P') dir = '?';
                    }
                }
            }
            lastDirection = dir;
            document.getElementById('current-direction').textContent = "Current Direction: " + (dir ? (emojiMap[dir] || dir) : '?');
        }

        function move(dir) {
            const result = Module.ccall('processMove', 'number', ['number'], [dir.charCodeAt(0)]);
            updateGrid();
            updateCurrentDirection();
            if (result === 0) {
            gameRunning = false;
            showPopup('Game Over!');
            } else if(result === 2) {
            gameRunning = false;
            showPopup("Congratulations! You've completed the game!");
            }

        }

        function useHint() {
            const hint = Module.ccall('getHint', 'string');
            showPopup("Hint: " + hint);
        }

        function showPopup(message) {
            document.getElementById('popup-message').textContent = message;
            document.getElementById('popup').style.display = 'flex';
            document.getElementById('game-ui').style.display = 'none';
        }

        function closePopup() {
            document.getElementById('popup').style.display = 'none';
            if (gameRunning) {
                document.getElementById('game-ui').style.display = '';
            } else {
                showInstructions();
            }
        }
    </script>

    <script src="edge-quest.js"></script>
</body>
</html>
